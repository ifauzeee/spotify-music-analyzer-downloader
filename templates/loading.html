{% extends 'layout.html' %}

{% block content %}
<div class="container" style="text-align: center; padding-top: 5rem;" id="loading-container" data-task-id="{{ task_id }}">
    <h1 id="loading-message">Memulai...</h1>
    <p>Harap tunggu, proses sedang berjalan.</p>
    
    <div class="progress-container">
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%;"></div>
        </div>
        <span id="progress-text" class="progress-text">0%</span>
    </div>

    <div id="result-container" class="results-section" style="display: none; margin-top: 2rem; text-align: left;">
        <h2 id="result-title"></h2>
        <div id="download-queue"></div>
    </div>

    <p id="error-message" style="color: #ff4d4d; display: none;"></p>
</div>

<script>
    const taskId = document.getElementById('loading-container').dataset.taskId;

    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const loadingMessage = document.getElementById('loading-message');
    const errorMessage = document.getElementById('error-message');
    const resultContainer = document.getElementById('result-container');
    const resultTitle = document.getElementById('result-title');
    const downloadQueue = document.getElementById('download-queue');

    function checkStatus() {
        if (!taskId) {
            errorMessage.textContent = 'Error: Task ID tidak ditemukan.';
            errorMessage.style.display = 'block';
            return;
        }

        fetch(`/status/${taskId}`)
            .then(response => {
                if (!response.ok) throw new Error(`Server returned status ${response.status}`);
                return response.json();
            })
            .then(data => {
                loadingMessage.textContent = data.message || 'Processing...';
                
                const result = data.result;

                if (result && result.type === 'download_queue') {
                    // Update UI untuk antrean download
                    resultContainer.style.display = 'block';
                    resultTitle.textContent = 'Download Queue';
                    
                    let tableHTML = '<table><thead><tr><th>#</th><th>Track</th><th>Status</th></tr></thead><tbody>';
                    result.tracks.forEach((track, index) => {
                        tableHTML += `<tr><td>${index + 1}</td><td>${track.name}</td><td>${track.status}</td></tr>`;
                    });
                    tableHTML += '</tbody></table>';
                    downloadQueue.innerHTML = tableHTML;
                    
                    const completed = result.tracks.filter(t => t.status === 'Selesai').length;
                    const total = result.tracks.length;
                    const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';

                } else {
                    // Update UI untuk progress bar biasa
                    progressBar.style.width = (data.progress || 0) + '%';
                    progressText.textContent = (data.progress || 0) + '%';
                }

                if (data.status === 'complete') {
                    if (result && result.type === 'analysis') {
                        window.location.href = `/results/${taskId}`;
                    } else if (result && result.type === 'download_queue') {
                        loadingMessage.textContent = 'Semua Download Selesai!';
                    }
                } else if (data.status === 'failed') {
                    errorMessage.textContent = 'Terjadi kesalahan: ' + data.message;
                    errorMessage.style.display = 'block';
                } else {
                    setTimeout(checkStatus, 2000);
                }
            })
            .catch(err => {
                console.error('Error checking status:', err);
                errorMessage.textContent = 'Gagal terhubung ke server untuk memeriksa status.';
                errorMessage.style.display = 'block';
            });
    }

    document.addEventListener('DOMContentLoaded', checkStatus);
</script>
{% endblock %}